<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title><%= title %></title>

    <%- include ('./part/head.ejs') %>

    <style>
        .company-info {
            font-size: 2rem;
        }

        .commute-self .btn {
            font-size: 1.8rem !important;
            padding: 1rem 0 !important;
            border-radius: 10%;
        }

        .commute-self {
        }

        .commute-self img {
            width: 48px;
            height: 48px;
        }

        .commute-self {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .commute-self .btn {
            width: 10rem;
            min-width: 10rem;
            height: 10rem;
            min-height: 10rem;
        }

        .commute-self table td {
            font-size: 2rem;
            padding: 2rem;
        }

        .commute-self table {
            border: 1px solid #DCDCDC;
        }

        .commute-self table th:not(:last-child),
        .commute-self table td:not(:last-child) {
            border-right: 1px solid #DCDCDC;
        }

        .commute-board {
            display: none;
            text-align: center;
            font-size: 2rem;
        }

        .commute-board .count {
            font-size: 4rem;
            font-weight: bold;
        }

        .notice-board .notice-title {
            cursor: pointer;
            text-align: left;
        }

        .notice-board .notice-title span {
            color: #2940d3;
            font-size: 1.4rem;
        }

        .schedule-board td:hover,
        .schedule-board td:focus,
        .schedule-board td:active,
        .notice-board .notice-title:hover {
            text-decoration: underline;
        }
    </style>
</head>

<header>
    <%- include ('part/header.ejs') %>
</header>

<body>
<%- include ('part/menu.ejs') %>
<div id="main">
    <div class="row main-title" id="today">
    </div>
    <div class="row company-info">
        <div class="col-lg" style="text-align: left">
            구이앤금우통신 - <span id="departmentName"></span>
        </div>
        <div class="col-lg" style="text-align: right">
            총 직원 수: <span id="memberCount"></span>명
        </div>
    </div>

    <div class="row content-box">
        <div class="content-box-title">🔹 주간일정</div>
        <div id="calendar" style="max-height: 30rem"></div>
    </div>
    <div class="row">
        <div class="col-xl content-box">
            <div class="content-box-title">🔹 출퇴근기록</div>
            <div class="row commute-self">
                <div style="width: fit-content;margin: 1rem">
                    <button type="button" class="btn btn-primary" onclick="request('attendance/onWork', onWork)">
                        <img src="/images/icon-on-work.png">
                        <div>출근</div>
                    </button>
                    <button type="button" class="btn btn-danger" onclick="request('attendance/offWork', offWork)">
                        <img src="/images/icon-off-work.png">
                        <div>퇴근</div>
                    </button>
                </div>
                <div style="width: 45rem">
                    <table>
                        <thead>
                        <tr>
                            <th width="50%">출근</th>
                            <th width="50%">퇴근</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="onWorkTime"></td>
                            <td id="offWorkTime"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-xl content-box">
            <div class="content-box-title">🔹 공지사항</div>
            <table class="notice-board">
                <thead>
                <tr>
                    <th width="10%">No</th>
                    <th width="50%">제목</th>
                    <th width="20%">작성자</th>
                    <th width="20%">등록일</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>1</td>
                    <td class="notice-title">첫공지입니당 <span>(10)</span></td>
                    <td>임현주</td>
                    <td>2021.06.07</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row commute-board">
        <div class="col-md content-box"
             style="border-top: 5px solid #576cfa;color: #1354d9">
            출근
            <div class="count" id="onWork"></div>
        </div>
        <div class="col-md content-box"
             style="border-top: 5px solid #ffb43d; color: #e07c00">
            미출근
            <div class="count" id="yetWork"></div>
        </div>
        <div class="col-md content-box"
             style="border-top: 5px solid #ff4848;color: #ff2d47">
            지각
            <div class="count" id="lateWork"></div>
        </div>
        <div class="col-md content-box"
             style="border-top: 5px solid #00bd00;color: #01853d">
            휴가
            <div class="count"></div>
        </div>
    </div>

</div>
</body>

</html>

<script>
    <%- include ('common/check-data.js') %>

    setBoardData();

    //전체 정보 조회
    function setBoardData() {
        let todayArr = getTodayArr(new Date());
        $("#today").text(todayArr[0] + "년 " + todayArr[1] + "월 " + todayArr[2] + "일 (" + todayArr[6] + ")");

        //부서정보 조회
        request('department/readDepartmentNameAndMemberCount', setDepartmentInfo);
        //일정요약(출퇴근) 조회
        request('attendance/readAttendanceSummary', setAttendanceSummary);
        //출퇴근기록 조회
        request('attendance/readAttendanceToday', setWorkBoard);

        let scheduleSendData = {};
        scheduleSendData.viewOption = 'all dep own';
        scheduleSendData.page = 0;
        scheduleSendData.size = 100;
        let today = new Date();
        scheduleSendData.startDate = getToday(today);
        scheduleSendData.endDate = getToday(new Date(today.setDate(today.getDate() + 7)));

        //주간일정 조회
        requestWithData('schedule/readScheduleList', scheduleSendData, setScheduleList);
    }

    //부서정보 조회
    function setDepartmentInfo(res) {
        if (res.code === null) {
            return;
        }
        if (res.code === 'RDAM001') {
            $("#departmentName").text(res.data.departmentName);
            $("#memberCount").text(res.data.memberCount);
        } else if (res.code === 'RDAM002') {
            alert("부서정보 조회 실패");
        } else if (res.code === 'RDAM003') {
            alert("부서정보 조회 실패\n소속된 부서가 존재하지 않습니다.");
        }
    }

    //일정요약(출퇴근) 조회
    function setAttendanceSummary(res) {
        if (res.code === null) {
            return;
        }
        if (res.code === 'RSS001') {
            $(".commute-board").css('display', 'flex');
            $("#onWork").text(res.data.onWork);
            $("#yetWork").text(res.data.yetWork);
            $("#lateWork").text(res.data.lateWork);
        } else if (res.code === 'RSS002') {
            alert("일정요약 조회 실패");
        } else if (res.code === 'RSS003') {
            $(".commute-board").hide();
            console.log("일정요약 조회 실패\n권한이 없습니다.");
        }
    }

    //주간일정 조회
    function setScheduleList(res) {
        if (res.code === null) {
            return;
        }
        if (res.code === 'RSL001') {
            let scheduleArr = new Array();
            for (let i = 0; i < res.data.length; i++) {
                var schedule = new Object();

                schedule.title = res.data[i].title + "　　" + res.data[i].memo;
                schedule.start = res.data[i].startDate;
                schedule.end = res.data[i].endDate;

                scheduleArr.push(schedule);
            }
            setCalendar(scheduleArr);

        } else if (res.code === 'RSL002') {
            alert("일정목록 조회 실패");
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        setCalendar();
    });

    //fullcalendar - 셋팅
    function setCalendar(data) {
        let calendarEl = document.getElementById('calendar');
        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'listWeek',
            locale: 'ko',
            events: data,

            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }
        });
        calendar.render();
    }


    //출근 기록
    function onWork(res) {
        if (res.code === null) {
            return;
        }
        if (res.code === 'ON001') {
            alert("출근이 기록되었습니다.");
            location.reload();
        } else if (res.code === 'ON002') {
            alert("출근 기록 실패");
        } else if (res.code === 'ON003') {
            alert("이미 출근 기록이 존재합니다.");
        } else if (res.code === 'ON004') {
            alert("권한이 없습니다.");
        }
    }

    //퇴근 기록
    function offWork(res) {
        if (res.code === null) {
            return;
        }
        if (res.code === 'OFF001') {
            alert("퇴근이 기록되었습니다.");
            location.reload();
        } else if (res.code === 'OFF002') {
            alert("퇴근 기록 실패");
        } else if (res.code === 'OFF003') {
            alert("이미 퇴근 기록이 존재합니다.");
        } else if (res.code === 'OFF004') {
            alert("권한이 없습니다.");
        } else if (res.code === 'OFF005') {
            alert("출근 기록이 존재하지 않습니다.");
        }
    }

    //출퇴근기록
    function setWorkBoard(res) {
        console.log(res);
        if (res.code === null) {
            return;
        }
        if (res.code === 'RA001') {
            $("#onWorkTime").text(res.data.onWork);
            $("#offWorkTime").text(res.data.offWork);
        } else if (res.code === 'RA002') {
            console.log("출근기록 조회 실패");
        } else if (res.code === 'RA003') {
            console.log("출근기록 조회 실패(출근정보 존재하지 않음)");
        }
    }

    function testFunc(res) {
        console.log(res);
        console.log(res);
        console.log(res);
        console.log(res);
    }
</script>