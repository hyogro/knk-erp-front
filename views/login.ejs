<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title><%= title %></title>

    <%- include ('./part/head.ejs') %>
    <link rel="stylesheet" type="text/css" href="/css/login.css">
</head>

<body>
<div class="login-card">
    <img class="logo" src="/images/logo2.png">

    <input type="text" id="id" placeholder="아이디" onkeyup="enterKey();">
    <input type="password" id="password" placeholder="비밀번호" onkeyup="enterKey();">
    <button type="submit" id="login" class="login login-submit">로그인</button>

    <div class="login-help">
        <a href="#">아이디찾기</a> | <a href="#">비밀번호찾기</a>
    </div>
</div>
</body>

</html>

<script>

    const token = $.cookie("token");

    // 이미 로그인된 상태
    if (token !== undefined && token !== "null") {
        location.href = "/";
    }

    function enterKey() {
        if (window.event.keyCode === 13) {
            login($("#id").val(), $("#password").val());
        }
    }

    //로그인버튼
    $("#login").click(function () {
        login($("#id").val(), $("#password").val());
    });

    function login(id, password) {
        if (isEmpty(id)) {
            alert('아이디를 입력해주세요.');
            return;
        } else if (isEmpty(password)) {
            alert('비밀번호를 입력해주세요.');
            return;
        }

        let loginData = {};
        loginData.memberId = id;
        loginData.password = password;

        loginRequest('account/login', loginData);
    }

    function loginRequest(url, data) {
        // ajax 통신
        $.ajax({
            type: "POST",
            url: '<%= api %>' + url,
            contentType: 'application/json; charset=UTF-8',
            dataType: 'json',
            data: JSON.stringify(data),
            success: function (res) {
                $.cookie('token', 'Bearer ' + res.tokenDto.accessToken, {expires: 1, path: '/'});
                $.cookie('id', data.memberId);
                location.href = '/';
            },
            error: function () {
                alert('등록되지 않은 아이디이거나, 잘못된 비밀번호입니다.');
            }
        });
    }

    function isEmpty(val) {
        return val == null || val === '';
    }
</script>